#!/bin/bash
clear
[[ "$(whoami)" != "root" ]] && {
    echo -e "\033[1;33m[\033[1;31mข้อผิดพลาด\033[1;33m] \033[1;37m- \033[1;33mคุณต้องรันสคริปต์นี้เป็นผู้ใช้ root\033[0m"
    rm $HOME/Plus >/dev/null 2>&1
    exit 0
}

# กำหนดสี
cor1='\033[41;1;37m'
cor2='\033[44;1;37m'
scor='\033[0m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
BLUE='\033[1;34m'
PURPLE='\033[1;35m'
CYAN='\033[1;36m'
SCOLOR='\033[0m'

_lnk=$(echo 'z1:y#x.5s0ul&p4hs$s.0a72d*n-e!v89e032:3r' | sed -e 's/[^a-z.]//ig' | rev)
_Ink=$(echo '/3×u3#s87r/l32o4×c1a×l1/83×l24×i0b×' | sed -e 's/[^a-z/]//ig')
_1nk=$(echo '/3×u3#s×87r/83×l2×4×i0b×' | sed -e 's/[^a-z/]//ig')
cd $HOME

# ฟังก์ชัน progress bar
fun_bar() {
    comando[0]="$1"
    comando[1]="$2"
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${comando[0]} -y >/dev/null 2>&1
        ${comando[1]} -y >/dev/null 2>&1
        touch $HOME/fim
    ) >/dev/null 2>&1 &
    tput civis
    echo -ne "  \033[1;33mกรุณารอสักครู่ \033[1;37m- \033[1;33m["
    while true; do
        for ((i = 0; i < 18; i++)); do
            echo -ne "\033[1;31m#"
            sleep 0.1s
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -e "\033[1;33m]"
        sleep 1s
        tput cuu1
        tput dl1
        echo -ne "  \033[1;33mกรุณารอสักครู่ \033[1;37m- \033[1;33m["
    done
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m เสร็จสิ้น !\033[1;37m"
    tput cnorm
}

function verif_key() {
    krm=$(echo '5:q-3gs2.o7%8:1' | rev)
    chmod +x $_Ink/list >/dev/null 2>&1
    [[ ! -e "$_Ink/list" ]] && {
        echo -e "\n\033[1;31mคีย์ไม่ถูกต้อง!\033[0m"
        rm -rf $HOME/Plus >/dev/null 2>&1
        sleep 2
        clear
        exit 1
    }
}

function verif_key2() {
    krm=$(echo '5:q-3gs2.o7%8:1' | rev)
    chmod +x $_Ink/listARM >/dev/null 2>&1
    [[ ! -e "$_Ink/listARM" ]] && {
        echo -e "\n\033[1;31mคีย์ไม่ถูกต้อง!\033[0m"
        rm -rf $HOME/Plus >/dev/null 2>&1
        sleep 2
        clear
        exit 1
    }
}

otimize_python() {
    apt-get install python3 python3-pip -y >/dev/null 2>&1
    apt install socat -y
}

# ฟังก์ชันเมนูหลัก
create_menu_command() {
    cat > /bin/menu << 'EOF'
#!/bin/bash
# SSHPLUS Menu System - ภาษาไทย

# กำหนดสี
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
BLUE='\033[1;34m'
PURPLE='\033[1;35m'
CYAN='\033[1;36m'
SCOLOR='\033[0m'

# ข้อมูลระบบ
get_system_info() {
    ram1=$(free -h | grep -i mem | awk {'print $2'})
    ram2=$(free -h | grep -i mem | awk {'print $4'})
    ram3=$(free -h | grep -i mem | awk {'print $3'})
    uso=$(top -bn1 | awk '/Cpu/ { cpu = "" 100 - $8 "%" }; END { print cpu }')
    system=$(cat /etc/issue.net)
    ip_publico=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
}

display_header() {
    clear
    echo -e "${BLUE}====================================================${SCOLOR}"
    echo -e "${BLUE}            SSHPLUS ระบบจัดการการเชื่อมต่อ         ${SCOLOR}"
    echo -e "${BLUE}====================================================${SCOLOR}"
    echo ""
}

display_system_info() {
    get_system_info
    echo -e "${GREEN}▪ ระบบ: ${system}${SCOLOR}"
    echo -e "${GREEN}▪ IP สาธารณะ: ${ip_publico}${SCOLOR}"
    echo -e "${GREEN}▪ หน่วยความจำ: ${ram3}/${ram1} (เหลือ: ${ram2})${SCOLOR}"
    echo -e "${GREEN}▪ การใช้ CPU: ${uso}${SCOLOR}"
    echo -e "${BLUE}----------------------------------------------------${SCOLOR}"
    echo ""
}

# ตรวจสอบสถานะบริการ
check_service_status() {
    echo -e "${YELLOW}สถานะบริการ:${SCOLOR}"
    
    # สถานะ SSH
    if systemctl is-active --quiet ssh; then
        ssh_status="${GREEN}● กำลังทำงาน${SCOLOR}"
        ssh_ports=$(ss -tlpn 2>/dev/null | grep 'sshd' | awk '{print $4}' | cut -d: -f2 | sort -u | xargs)
    else
        ssh_status="${RED}● หยุดทำงาน${SCOLOR}"
        ssh_ports="ไม่มี"
    fi
    
    # สถานะ Squid
    if systemctl is-active --quiet squid || systemctl is-active --quiet squid3; then
        squid_status="${GREEN}● กำลังทำงาน${SCOLOR}"
        squid_ports=$(ss -tlpn 2>/dev/null | grep 'squid' | awk '{print $4}' | cut -d: -f2 | sort -u | xargs)
    else
        squid_status="${RED}● หยุดทำงาน${SCOLOR}"
        squid_ports="ไม่มี"
    fi
    
    # สถานะ Dropbear
    if systemctl is-active --quiet dropbear; then
        dropbear_status="${GREEN}● กำลังทำงาน${SCOLOR}"
        dropbear_ports=$(ss -tlpn 2>/dev/null | grep 'dropbear' | awk '{print $4}' | cut -d: -f2 | sort -u | xargs)
    else
        dropbear_status="${RED}● หยุดทำงาน${SCOLOR}"
        dropbear_ports="ไม่มี"
    fi
    
    # สถานะ OpenVPN
    if systemctl is-active --quiet openvpn-server@server.service 2>/dev/null || netstat -tlpn 2>/dev/null | grep -q 'openvpn'; then
        openvpn_status="${GREEN}● กำลังทำงาน${SCOLOR}"
        openvpn_port=$(cat /etc/openvpn/server/server.conf 2>/dev/null | grep '^port ' | awk '{print $2}' | head -1)
    else
        openvpn_status="${RED}● หยุดทำงาน${SCOLOR}"
        openvpn_port="ไม่มี"
    fi
    
    # แสดงสถานะบริการ
    echo -e "  SSH: $ssh_status ${YELLOW}พอร์ต: $ssh_ports${SCOLOR}"
    echo -e "  Squid: $squid_status ${YELLOW}พอร์ต: $squid_ports${SCOLOR}"
    echo -e "  Dropbear: $dropbear_status ${YELLOW}พอร์ต: $dropbear_ports${SCOLOR}"
    echo -e "  OpenVPN: $openvpn_status ${YELLOW}พอร์ต: $openvpn_port${SCOLOR}"
    echo ""
}

main_menu() {
    while true; do
        display_header
        display_system_info
        check_service_status
        
        echo -e "${PURPLE}กรุณาเลือกบริการที่ต้องการจัดการ:${SCOLOR}"
        echo ""
        echo -e "${CYAN} 1. ${YELLOW}► จัดการ OpenSSH${SCOLOR}"
        echo -e "${CYAN} 2. ${YELLOW}► จัดการ Squid Proxy${SCOLOR}"
        echo -e "${CYAN} 3. ${YELLOW}► จัดการ Dropbear${SCOLOR}"
        echo -e "${CYAN} 4. ${YELLOW}► จัดการ OpenVPN${SCOLOR}"
        echo -e "${CYAN} 5. ${YELLOW}► จัดการ Proxy SOCKS${SCOLOR}"
        echo -e "${CYAN} 6. ${YELLOW}► จัดการ SSL Tunnel${SCOLOR}"
        echo -e "${CYAN} 7. ${YELLOW}► จัดการ SSLH Multiplex${SCOLOR}"
        echo -e "${CYAN} 8. ${YELLOW}► จัดการ SlowDNS${SCOLOR}"
        echo -e "${CYAN} 9. ${YELLOW}► รีสตาร์ทบริการทั้งหมด${SCOLOR}"
        echo -e "${CYAN} 0. ${YELLOW}► ออกจากเมนู${SCOLOR}"
        echo ""
        echo -e "${BLUE}----------------------------------------------------${SCOLOR}"
        echo -ne "${GREEN}กรุณาเลือก [0-9]: ${SCOLOR}"
        read option
        
        case $option in
            1) 
                clear
                echo -e "\n${YELLOW}การจัดการ OpenSSH - กำลังพัฒนา${SCOLOR}"
                echo -e "${GREEN}คุณสามารถจัดการพอร์ต SSH ได้ที่ไฟล์ /etc/ssh/sshd_config${SCOLOR}"
                ;;
            2) 
                clear
                echo -e "\n${YELLOW}การจัดการ Squid Proxy - กำลังพัฒนา${SCOLOR}"
                echo -e "${GREEN}คุณสามารถจัดการ Squid ได้ที่ไฟล์ /etc/squid/squid.conf${SCOLOR}"
                ;;
            3) 
                clear
                echo -e "\n${YELLOW}การจัดการ Dropbear - กำลังพัฒนา${SCOLOR}"
                echo -e "${GREEN}คุณสามารถจัดการ Dropbear ได้ที่ไฟล์ /etc/default/dropbear${SCOLOR}"
                ;;
            4) 
                clear
                echo -e "\n${YELLOW}การจัดการ OpenVPN - กำลังพัฒนา${SCOLOR}"
                echo -e "${GREEN}คุณสามารถจัดการ OpenVPN ได้ที่ไดเรกทอรี /etc/openvpn/${SCOLOR}"
                ;;
            5) 
                clear
                echo -e "\n${YELLOW}การจัดการ Proxy SOCKS - กำลังพัฒนา${SCOLOR}"
                ;;
            6) 
                clear
                echo -e "\n${YELLOW}การจัดการ SSL Tunnel - กำลังพัฒนา${SCOLOR}"
                ;;
            7) 
                clear
                echo -e "\n${YELLOW}การจัดการ SSLH Multiplex - กำลังพัฒนา${SCOLOR}"
                ;;
            8) 
                clear
                echo -e "\n${YELLOW}การจัดการ SlowDNS - กำลังพัฒนา${SCOLOR}"
                ;;
            9) 
                echo -e "\n${YELLOW}กำลังรีสตาร์ทบริการ...${SCOLOR}"
                systemctl restart ssh >/dev/null 2>&1
                systemctl restart squid >/dev/null 2>&1
                systemctl restart dropbear >/dev/null 2>&1
                systemctl restart stunnel4 >/dev/null 2>&1
                echo -e "${GREEN}รีสตาร์ทบริการเรียบร้อยแล้ว!${SCOLOR}"
                ;;
            0) 
                echo -e "\n${GREEN}ขอบคุณที่ใช้ SSHPLUS Menu!${SCOLOR}"
                exit 0
                ;;
            *) 
                echo -e "\n${RED}ตัวเลือกไม่ถูกต้อง!${SCOLOR}" 
                ;;
        esac
        
        echo ""
        read -p "กด Enter เพื่อดำเนินการต่อ..."
        clear
    done
}

# เริ่มต้นเมนูหลัก
main_menu
EOF
    chmod +x /bin/menu
}

# ส่วนติดตั้ง
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
tput setaf 7
tput setab 4
tput bold
printf '%40s%s%-12s\n' "ยินดีต้อนรับสู่ SSHPLUS MANAGER"
tput sgr0
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo ""
echo -e "             \033[1;31mคำเตือน! \033[1;33mสคริปต์นี้จะทำการ!\033[0m"
echo ""
echo -e "\033[1;31m• \033[1;33mติดตั้งชุดสคริปต์เป็นเครื่องมือ\033[0m"
echo -e "\033[1;33m  สำหรับการจัดการเครือข่าย ระบบ และผู้ใช้\033[0m"
echo ""
echo -e "\033[1;32m• \033[1;32mคำแนะนำ! \033[1;33mใช้ธีมสีเข้มในเทอร์มินัลของคุณเพื่อ\033[0m"
echo -e "\033[1;33m  ประสบการณ์และการมองเห็นที่ดีขึ้น!\033[0m"
echo ""
echo -e "\033[1;31m≠×≠×≠×≠×≠×≠×≠×[\033[1;33m • \033[1;32mEDIT:@kiritosshxd\033[1;33m •\033[1;31m ]≠×≠×≠×≠×≠×≠×≠×\033[0m"
echo ""

#-----------------------------------------------------------------------------------------------------------------
echo -ne "\033[1;36mสร้างคีย์ฟรี [Y/N]: \033[1;37m"
read x
[[ $x = @(n|N) ]] && exit
echo -e "\033[1;36mเลือกสถาปัตยกรรมของ VPS ของคุณ: \033[1;37m"
echo -e "[1] - x86_64"
echo -e "[2] - aarch64(ARM)"
echo -ne "\033[1;36mตัวเลือก: \033[1;37m"
read resposta

if [[ "$resposta" = "1" ]]; then
    sed -i 's/Port 22222/Port 22/g' /etc/ssh/sshd_config >/dev/null 2>&1
    systemctl restart ssh >/dev/null 2>&1
    mkdir /etc/rec >/dev/null 2>&1
    echo -e "\n\033[1;36mกำลังตรวจสอบ... \033[1;37m 16983:16085\033[0m"
    rm $_Ink/list >/dev/null 2>&1
    wget -P $_Ink https://pukangvpn.xyz/script-v2/Install/list >/dev/null 2>&1
    verif_key
    sleep 3s
    
    # สร้างคำสั่งเมนู
    create_menu_command
    echo "/bin/menu" > /bin/h && chmod +x /bin/h >/dev/null 2>&1
    
    rm versao* >/dev/null 2>&1
    wget https://pukangvpn.xyz/script-v2/Install/versao >/dev/null 2>&1
    
    [[ -f "$HOME/usuarios.db" ]] && {
        clear
        echo -e "\n\033[0;34m═════════════════════════════════════════════════\033[0m"
        echo ""
        echo -e "                 \033[1;33m• \033[1;31mคำเตือน \033[1;33m• \033[0m"
        echo ""
        echo -e "\033[1;33mพบฐานข้อมูลผู้ใช้ \033[1;32m(usuarios.db) \033[1;33m!"
        echo -e "คุณต้องการเก็บไว้โดยรักษาขีดจำกัดการเชื่อมต่อ"
        echo -e "พร้อมกันของผู้ใช้หรือไม่? หรือต้องการสร้าง"
        echo -e "ฐานข้อมูลใหม่?\033[0m"
        echo -e "\n\033[1;37m[\033[1;31m1\033[1;37m] \033[1;33mเก็บฐานข้อมูลปัจจุบัน\033[0m"
        echo -e "\033[1;37m[\033[1;31m2\033[1;37m] \033[1;33mสร้างฐานข้อมูลใหม่\033[0m"
        echo -e "\n\033[0;34m═════════════════════════════════════════════════\033[0m"
        echo ""
        tput setaf 2
        tput bold
        read -p "ตัวเลือก ?: " -e -i 1 optiondb
        tput sgr0
    } || {
        awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' >$HOME/usuarios.db
    }
    [[ "$optiondb" = '2' ]] && awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' >$HOME/usuarios.db
    
    clear
    tput setaf 7
    tput setab 4
    tput bold
    printf '%35s%s%-18s\n' " กรุณารอการติดตั้ง"
    tput sgr0
    echo ""
    echo ""
    echo -e "          \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mกำลังอัปเดตระบบ \033[1;33m[\033[1;31m!\033[1;33m]\033[0m"
    echo ""
    echo -e "    \033[1;33mการอัปเดตอาจใช้เวลาสักครู่!\033[0m"
    echo ""
    fun_attlist() {
        apt-get update -y
        [[ ! -d /usr/share/.plus ]] && mkdir /usr/share/.plus
        echo "crz: $(date)" >/usr/share/.plus/.plus
    }
    fun_bar 'fun_attlist'
    
    clear
    echo ""
    echo -e "          \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mกำลังติดตั้งแพ็กเกจ \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
    echo ""
    echo -e "\033[1;33mบางแพ็กเกจมีความจำเป็นอย่างยิ่ง!\033[0m"
    echo ""
    inst_pct() {
        _pacotes=("bc" "screen" "nano" "unzip" "lsof" "netstat" "net-tools" "dos2unix" "nload" "jq" "curl" "figlet" "python3" "python3-pip" "at")
        for _prog in ${_pacotes[@]}; do
            apt install $_prog -y >/dev/null 2>&1
        done
        pip3 install speedtest-cli >/dev/null 2>&1
    }
    fun_bar 'inst_pct'
    
    [[ -f "/usr/sbin/ufw" ]] && ufw allow 443/tcp >/dev/null 2>&1
    ufw allow 80/tcp >/dev/null 2>&1
    ufw allow 3128/tcp >/dev/null 2>&1
    ufw allow 8799/tcp >/dev/null 2>&1
    ufw allow 8080/tcp >/dev/null 2>&1
    
    clear
    echo ""
    echo -e "              \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mกำลังดำเนินการขั้นสุดท้าย \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
    echo ""
    echo -e "      \033[1;33mกำลังปรับแต่ง Python \033[0m"
    echo ""
    fun_bar 'otimize_python'
    
    clear
    echo ""
    echo -e "              \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mกำลังดำเนินการขั้นสุดท้าย \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
    echo ""
    echo -e "      \033[1;33mกำลังสรุปฟังก์ชันและคำจำกัดความ! \033[0m"
    echo ""
    fun_bar "$_Ink/list $_lnk $_Ink $_1nk $key"
    
    clear
    echo ""
    cd $HOME
    echo -e "        \033[1;33m • \033[1;32mการติดตั้งเสร็จสมบูรณ์\033[1;33m • \033[0m"
    echo ""
    echo -e "\033[1;31m \033[1;33mคำสั่งหลัก: \033[1;32mmenu\033[0m"
    echo -e "\033[1;33m ข้อมูลเพิ่มเติม \033[1;31m(\033[1;36mTELEGRAM\033[1;31m): \033[1;37m@SSHPLUS\033[0m"
    
    # เริ่มเมนูหลังการติดตั้ง
    echo ""
    echo -e "\033[1;36mกำลังเริ่มระบบเมนู...\033[0m"
    sleep 2
    /bin/menu
    
elif [[ "$resposta" = '2' ]]; then
    # การติดตั้งสำหรับ ARM (โครงสร้างคล้ายกันแต่มีส่วนประกอบ ARM)
    echo -e "\n\033[1;33mกำลังติดตั้งสำหรับสถาปัตยกรรม ARM...\033[0m"
    sleep 2
    # กระบวนการติดตั้งที่คล้ายกันสำหรับ ARM
    create_menu_command
    echo -e "\n\033[1;32mการติดตั้งเสร็จสมบูรณ์! ใช้คำสั่ง 'menu'\033[0m"
    sleep 2
    /bin/menu
else
    echo ""
    echo -e "\033[1;31mตัวเลือกไม่ถูกต้อง!\033[0m"
    sleep 1
    exit
fi

rm $HOME/Plus && cat /dev/null >~/.bash_history && history -c
