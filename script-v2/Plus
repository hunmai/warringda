#!/bin/bash
clear
[[ "$(whoami)" != "root" ]] && {
    echo -e "\033[1;33m[\033[1;31mError\033[1;33m] \033[1;37m- \033[1;33myou need to run as root\033[0m"
    rm $HOME/Plus >/dev/null 2>&1
    exit 0
}

# Color definitions
cor1='\033[41;1;37m'
cor2='\033[44;1;37m'
scor='\033[0m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
BLUE='\033[1;34m'
PURPLE='\033[1;35m'
CYAN='\033[1;36m'
SCOLOR='\033[0m'

_lnk=$(echo 'z1:y#x.5s0ul&p4hs$s.0a72d*n-e!v89e032:3r' | sed -e 's/[^a-z.]//ig' | rev)
_Ink=$(echo '/3×u3#s87r/l32o4×c1a×l1/83×l24×i0b×' | sed -e 's/[^a-z/]//ig')
_1nk=$(echo '/3×u3#s×87r/83×l2×4×i0b×' | sed -e 's/[^a-z/]//ig')
cd $HOME

# Progress bar function
fun_bar() {
    comando[0]="$1"
    comando[1]="$2"
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${comando[0]} -y >/dev/null 2>&1
        ${comando[1]} -y >/dev/null 2>&1
        touch $HOME/fim
    ) >/dev/null 2>&1 &
    tput civis
    echo -ne "  \033[1;33mPLEASE WAIT \033[1;37m- \033[1;33m["
    while true; do
        for ((i = 0; i < 18; i++)); do
            echo -ne "\033[1;31m#"
            sleep 0.1s
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -e "\033[1;33m]"
        sleep 1s
        tput cuu1
        tput dl1
        echo -ne "  \033[1;33mPLEASE WAIT \033[1;37m- \033[1;33m["
    done
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m OK !\033[1;37m"
    tput cnorm
}

function verif_key() {
    krm=$(echo '5:q-3gs2.o7%8:1' | rev)
    chmod +x $_Ink/list >/dev/null 2>&1
    [[ ! -e "$_Ink/list" ]] && {
        echo -e "\n\033[1;31mINVALID KEY!\033[0m"
        rm -rf $HOME/Plus >/dev/null 2>&1
        sleep 2
        clear
        exit 1
    }
}

function verif_key2() {
    krm=$(echo '5:q-3gs2.o7%8:1' | rev)
    chmod +x $_Ink/listARM >/dev/null 2>&1
    [[ ! -e "$_Ink/listARM" ]] && {
        echo -e "\n\033[1;31mINVALID KEY!\033[0m"
        rm -rf $HOME/Plus >/dev/null 2>&1
        sleep 2
        clear
        exit 1
    }
}

otimize_python() {
    apt-get install python3 python3-pip -y >/dev/null 2>&1
    apt install socat -y
}

# System information
get_system_info() {
    ram1=$(free -h | grep -i mem | awk {'print $2'})
    ram2=$(free -h | grep -i mem | awk {'print $4'})
    ram3=$(free -h | grep -i mem | awk {'print $3'})
    uso=$(top -bn1 | awk '/Cpu/ { cpu = "" 100 - $8 "%" }; END { print cpu }')
    system=$(cat /etc/issue.net)
    ip_publico=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
}

# Display header
display_header() {
    clear
    echo -e "${cor2}====================================================${scor}"
    echo -e "${cor2}               SSHPLUS CONNECTION MANAGER          ${scor}"
    echo -e "${cor2}====================================================${scor}"
    echo ""
}

# Display system information
display_system_info() {
    get_system_info
    echo -e "${GREEN}▪ System: ${system}${SCOLOR}"
    echo -e "${GREEN}▪ Public IP: ${ip_publico}${SCOLOR}"
    echo -e "${GREEN}▪ Memory: ${ram3}/${ram1} (Available: ${ram2})${SCOLOR}"
    echo -e "${GREEN}▪ CPU Usage: ${uso}${SCOLOR}"
    echo -e "${BLUE}----------------------------------------------------${SCOLOR}"
    echo ""
}

# Service status check
check_service_status() {
    echo -e "${YELLOW}Service Status:${SCOLOR}"
    
    # SSH Status
    if systemctl is-active --quiet ssh; then
        ssh_status="${GREEN}● Running${SCOLOR}"
        ssh_ports=$(ss -tlpn 2>/dev/null | grep 'sshd' | awk '{print $4}' | cut -d: -f2 | sort -u | xargs)
    else
        ssh_status="${RED}● Stopped${SCOLOR}"
        ssh_ports="None"
    fi
    
    # Squid Status
    if systemctl is-active --quiet squid || systemctl is-active --quiet squid3; then
        squid_status="${GREEN}● Running${SCOLOR}"
        squid_ports=$(ss -tlpn 2>/dev/null | grep 'squid' | awk '{print $4}' | cut -d: -f2 | sort -u | xargs)
    else
        squid_status="${RED}● Stopped${SCOLOR}"
        squid_ports="None"
    fi
    
    # Dropbear Status
    if systemctl is-active --quiet dropbear; then
        dropbear_status="${GREEN}● Running${SCOLOR}"
        dropbear_ports=$(ss -tlpn 2>/dev/null | grep 'dropbear' | awk '{print $4}' | cut -d: -f2 | sort -u | xargs)
    else
        dropbear_status="${RED}● Stopped${SCOLOR}"
        dropbear_ports="None"
    fi
    
    # OpenVPN Status
    if systemctl is-active --quiet openvpn-server@server.service 2>/dev/null || netstat -tlpn 2>/dev/null | grep -q 'openvpn'; then
        openvpn_status="${GREEN}● Running${SCOLOR}"
        openvpn_port=$(cat /etc/openvpn/server/server.conf 2>/dev/null | grep '^port ' | awk '{print $2}' | head -1)
    else
        openvpn_status="${RED}● Stopped${SCOLOR}"
        openvpn_port="None"
    fi
    
    # Stunnel Status
    if systemctl is-active --quiet stunnel4; then
        stunnel_status="${GREEN}● Running${SCOLOR}"
        stunnel_ports=$(ss -tlpn 2>/dev/null | grep 'stunnel' | awk '{print $4}' | cut -d: -f2 | sort -u | xargs)
    else
        stunnel_status="${RED}● Stopped${SCOLOR}"
        stunnel_ports="None"
    fi
    
    # SSLH Status
    if systemctl is-active --quiet sslh; then
        sslh_status="${GREEN}● Running${SCOLOR}"
        sslh_port="443"
    else
        sslh_status="${RED}● Stopped${SCOLOR}"
        sslh_port="None"
    fi
    
    # Display service status
    echo -e "  SSH: $ssh_status ${YELLOW}Ports: $ssh_ports${SCOLOR}"
    echo -e "  Squid: $squid_status ${YELLOW}Ports: $squid_ports${SCOLOR}"
    echo -e "  Dropbear: $dropbear_status ${YELLOW}Ports: $dropbear_ports${SCOLOR}"
    echo -e "  OpenVPN: $openvpn_status ${YELLOW}Port: $openvpn_port${SCOLOR}"
    echo -e "  Stunnel: $stunnel_status ${YELLOW}Ports: $stunnel_ports${SCOLOR}"
    echo -e "  SSLH: $sslh_status ${YELLOW}Port: $sslh_port${SCOLOR}"
    echo ""
}

# Main connection menu
fun_conexao() {
    while true; do
        display_header
        display_system_info
        check_service_status
        
        echo -e "${PURPLE}Please select service to manage:${SCOLOR}"
        echo ""
        echo -e "${CYAN} 1. ${YELLOW}► OpenSSH Management${SCOLOR}"
        echo -e "${CYAN} 2. ${YELLOW}► Squid Proxy Management${SCOLOR}"
        echo -e "${CYAN} 3. ${YELLOW}► Dropbear Management${SCOLOR}"
        echo -e "${CYAN} 4. ${YELLOW}► OpenVPN Management${SCOLOR}"
        echo -e "${CYAN} 5. ${YELLOW}► Proxy SOCKS Management${SCOLOR}"
        echo -e "${CYAN} 6. ${YELLOW}► SSL Tunnel Management${SCOLOR}"
        echo -e "${CYAN} 7. ${YELLOW}► SSLH Multiplex Management${SCOLOR}"
        echo -e "${CYAN} 8. ${YELLOW}► SlowDNS Management${SCOLOR}"
        echo -e "${CYAN} 9. ${YELLOW}► Restart All Services${SCOLOR}"
        echo -e "${CYAN} 0. ${YELLOW}► Exit Menu${SCOLOR}"
        echo ""
        echo -e "${BLUE}----------------------------------------------------${SCOLOR}"
        echo -ne "${GREEN}Enter your choice [0-9]: ${SCOLOR}"
        read option
        
        case $option in
            1)
                clear
                echo -e "${YELLOW}OpenSSH Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            2)
                clear
                echo -e "${YELLOW}Squid Proxy Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            3)
                clear
                echo -e "${YELLOW}Dropbear Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            4)
                clear
                echo -e "${YELLOW}OpenVPN Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            5)
                clear
                echo -e "${YELLOW}Proxy SOCKS Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            6)
                clear
                echo -e "${YELLOW}SSL Tunnel Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            7)
                clear
                echo -e "${YELLOW}SSLH Multiplex Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            8)
                clear
                echo -e "${YELLOW}SlowDNS Management - Coming Soon${SCOLOR}"
                read -p "Press Enter to continue..."
                ;;
            9)
                clear
                echo -e "${YELLOW}Restarting all services...${SCOLOR}"
                echo ""
                services=("ssh" "squid" "dropbear" "stunnel4" "sslh")
                for service in "${services[@]}"; do
                    if systemctl is-active --quiet "$service" 2>/dev/null; then
                        echo -e "${CYAN}Restarting $service...${SCOLOR}"
                        systemctl restart "$service" >/dev/null 2>&1
                        if systemctl is-active --quiet "$service" 2>/dev/null; then
                            echo -e "${GREEN}✓ $service restarted successfully${SCOLOR}"
                        else
                            echo -e "${RED}✗ $service restart failed${SCOLOR}"
                        fi
                    fi
                done
                echo ""
                echo -e "${GREEN}All services restarted successfully!${SCOLOR}"
                echo ""
                read -p "Press Enter to continue..."
                ;;
            0)
                clear
                echo -e "${GREEN}Thank you for using SSHPLUS Menu!${SCOLOR}"
                echo ""
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid selection, please try again!${SCOLOR}"
                sleep 2
                ;;
        esac
    done
}

# Create menu command
create_menu_command() {
    cat > /bin/menu << 'EOF'
#!/bin/bash
# SSHPLUS Menu System

# Color definitions
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
BLUE='\033[1;34m'
PURPLE='\033[1;35m'
CYAN='\033[1;36m'
SCOLOR='\033[0m'

# System information
get_system_info() {
    ram1=$(free -h | grep -i mem | awk {'print $2'})
    ram2=$(free -h | grep -i mem | awk {'print $4'})
    ram3=$(free -h | grep -i mem | awk {'print $3'})
    uso=$(top -bn1 | awk '/Cpu/ { cpu = "" 100 - $8 "%" }; END { print cpu }')
    system=$(cat /etc/issue.net)
    ip_publico=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
}

display_header() {
    clear
    echo -e "${BLUE}====================================================${SCOLOR}"
    echo -e "${BLUE}               SSHPLUS CONNECTION MANAGER          ${SCOLOR}"
    echo -e "${BLUE}====================================================${SCOLOR}"
    echo ""
}

display_system_info() {
    get_system_info
    echo -e "${GREEN}▪ System: ${system}${SCOLOR}"
    echo -e "${GREEN}▪ Public IP: ${ip_publico}${SCOLOR}"
    echo -e "${GREEN}▪ Memory: ${ram3}/${ram1} (Available: ${ram2})${SCOLOR}"
    echo -e "${GREEN}▪ CPU Usage: ${uso}${SCOLOR}"
    echo -e "${BLUE}----------------------------------------------------${SCOLOR}"
    echo ""
}

main_menu() {
    while true; do
        display_header
        display_system_info
        
        echo -e "${PURPLE}Please select service to manage:${SCOLOR}"
        echo ""
        echo -e "${CYAN} 1. ${YELLOW}► OpenSSH Management${SCOLOR}"
        echo -e "${CYAN} 2. ${YELLOW}► Squid Proxy Management${SCOLOR}"
        echo -e "${CYAN} 3. ${YELLOW}► Dropbear Management${SCOLOR}"
        echo -e "${CYAN} 4. ${YELLOW}► OpenVPN Management${SCOLOR}"
        echo -e "${CYAN} 5. ${YELLOW}► Proxy SOCKS Management${SCOLOR}"
        echo -e "${CYAN} 6. ${YELLOW}► SSL Tunnel Management${SCOLOR}"
        echo -e "${CYAN} 7. ${YELLOW}► SSLH Multiplex Management${SCOLOR}"
        echo -e "${CYAN} 8. ${YELLOW}► SlowDNS Management${SCOLOR}"
        echo -e "${CYAN} 9. ${YELLOW}► Restart All Services${SCOLOR}"
        echo -e "${CYAN} 0. ${YELLOW}► Exit Menu${SCOLOR}"
        echo ""
        echo -e "${BLUE}----------------------------------------------------${SCOLOR}"
        echo -ne "${GREEN}Enter your choice [0-9]: ${SCOLOR}"
        read option
        
        case $option in
            1) echo -e "\n${YELLOW}OpenSSH Management - Coming Soon${SCOLOR}" ;;
            2) echo -e "\n${YELLOW}Squid Proxy Management - Coming Soon${SCOLOR}" ;;
            3) echo -e "\n${YELLOW}Dropbear Management - Coming Soon${SCOLOR}" ;;
            4) echo -e "\n${YELLOW}OpenVPN Management - Coming Soon${SCOLOR}" ;;
            5) echo -e "\n${YELLOW}Proxy SOCKS Management - Coming Soon${SCOLOR}" ;;
            6) echo -e "\n${YELLOW}SSL Tunnel Management - Coming Soon${SCOLOR}" ;;
            7) echo -e "\n${YELLOW}SSLH Multiplex Management - Coming Soon${SCOLOR}" ;;
            8) echo -e "\n${YELLOW}SlowDNS Management - Coming Soon${SCOLOR}" ;;
            9) 
                echo -e "\n${YELLOW}Restarting services...${SCOLOR}"
                systemctl restart ssh squid dropbear 2>/dev/null
                echo -e "${GREEN}Services restarted!${SCOLOR}"
                ;;
            0) 
                echo -e "\n${GREEN}Goodbye!${SCOLOR}"
                exit 0
                ;;
            *) echo -e "\n${RED}Invalid option!${SCOLOR}" ;;
        esac
        
        echo ""
        read -p "Press Enter to continue..."
        clear
    done
}

main_menu
EOF
    chmod +x /bin/menu
}

echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
tput setaf 7
tput setab 4
tput bold
printf '%40s%s%-12s\n' "WELCOME TO SSHPLUS MANAGER"
tput sgr0
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo ""
echo -e "             \033[1;31mATTENTION! \033[1;33mTHIS SCRIPT WILL!\033[0m"
echo ""
echo -e "\033[1;31m• \033[1;33mINSTALL A SET OF SCRIPTS AS TOOLS\033[0m"
echo -e "\033[1;33m  FOR NETWORK, SYSTEM AND USER MANAGEMENT\033[0m"
echo ""
echo -e "\033[1;32m• \033[1;32mTIP! \033[1;33mUSE DARK THEME IN YOUR TERMINAL FOR\033[0m"
echo -e "\033[1;33m  A BETTER EXPERIENCE AND VISUALIZATION!\033[0m"
echo ""
echo -e "\033[1;31m≠×≠×≠×≠×≠×≠×≠×[\033[1;33m • \033[1;32mEDIT:@kiritosshxd\033[1;33m •\033[1;31m ]≠×≠×≠×≠×≠×≠×≠×\033[0m"
echo ""

#-----------------------------------------------------------------------------------------------------------------
echo -ne "\033[1;36mGENERATE FREE KEYS [Y/N]: \033[1;37m"
read x
[[ $x = @(n|N) ]] && exit
echo -e "\033[1;36mSelect your VPS Architecture: \033[1;37m"
echo -e "[1] - x86_64"
echo -e "[2] - aarch64(ARM)"
echo -ne "\033[1;36mOption: \033[1;37m"
read resposta

if [[ "$resposta" = "1" ]]; then
    sed -i 's/Port 22222/Port 22/g' /etc/ssh/sshd_config >/dev/null 2>&1
    systemctl restart ssh >/dev/null 2>&1
    mkdir /etc/rec >/dev/null 2>&1
    echo -e "\n\033[1;36mVERIFYING... \033[1;37m 16983:16085\033[0m"
    rm $_Ink/list >/dev/null 2>&1
    wget -P $_Ink https://pukangvpn.xyz/script-v2/Install/list >/dev/null 2>&1
    verif_key
    sleep 3s
    
    # Create menu command
    create_menu_command
    
    rm versao* >/dev/null 2>&1
    wget https://pukangvpn.xyz/script-v2/Install/versao >/dev/null 2>&1
    
    [[ -f "$HOME/usuarios.db" ]] && {
        clear
        echo -e "\n\033[0;34m═════════════════════════════════════════════════\033[0m"
        echo ""
        echo -e "                 \033[1;33m• \033[1;31mATTENTION \033[1;33m• \033[0m"
        echo ""
        echo -e "\033[1;33mA User Database \033[1;32m(usuarios.db) \033[1;33mWas"
        echo -e "Found! Do you want to keep it preserving the limit"
        echo -e "of simultaneous connections of users? Or do you want"
        echo -e "to create a new database?\033[0m"
        echo -e "\n\033[1;37m[\033[1;31m1\033[1;37m] \033[1;33mKeep Current Database\033[0m"
        echo -e "\033[1;37m[\033[1;31m2\033[1;37m] \033[1;33mCreate New Database\033[0m"
        echo -e "\n\033[0;34m═════════════════════════════════════════════════\033[0m"
        echo ""
        tput setaf 2
        tput bold
        read -p "Option ?: " -e -i 1 optiondb
        tput sgr0
    } || {
        awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' >$HOME/usuarios.db
    }
    [[ "$optiondb" = '2' ]] && awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' >$HOME/usuarios.db
    
    clear
    tput setaf 7
    tput setab 4
    tput bold
    printf '%35s%s%-18s\n' " PLEASE WAIT FOR INSTALLATION"
    tput sgr0
    echo ""
    echo ""
    echo -e "          \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mUPDATING SYSTEM \033[1;33m[\033[1;31m!\033[1;33m]\033[0m"
    echo ""
    echo -e "    \033[1;33mUPDATES USUALLY TAKE A WHILE!\033[0m"
    echo ""
    fun_attlist() {
        apt-get update -y
        [[ ! -d /usr/share/.plus ]] && mkdir /usr/share/.plus
        echo "crz: $(date)" >/usr/share/.plus/.plus
    }
    fun_bar 'fun_attlist'
    
    clear
    echo ""
    echo -e "          \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mINSTALLING PACKAGES \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
    echo ""
    echo -e "\033[1;33mSOME PACKAGES ARE EXTREMELY NECESSARY!\033[0m"
    echo ""
    inst_pct() {
        _pacotes=("bc" "screen" "nano" "unzip" "lsof" "netstat" "net-tools" "dos2unix" "nload" "jq" "curl" "figlet" "python3" "python3-pip" "at")
        for _prog in ${_pacotes[@]}; do
            apt install $_prog -y >/dev/null 2>&1
        done
        pip3 install speedtest-cli >/dev/null 2>&1
    }
    fun_bar 'inst_pct'
    
    [[ -f "/usr/sbin/ufw" ]] && ufw allow 443/tcp >/dev/null 2>&1
    ufw allow 80/tcp >/dev/null 2>&1
    ufw allow 3128/tcp >/dev/null 2>&1
    ufw allow 8799/tcp >/dev/null 2>&1
    ufw allow 8080/tcp >/dev/null 2>&1
    
    clear
    echo ""
    echo -e "              \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mFINALIZING \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
    echo ""
    echo -e "      \033[1;33mOPTIMIZING PYTHON \033[0m"
    echo ""
    fun_bar 'otimize_python'
    
    clear
    echo ""
    echo -e "              \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mFINALIZING \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
    echo ""
    echo -e "      \033[1;33mCOMPLETING FUNCTIONS AND DEFINITIONS! \033[0m"
    echo ""
    fun_bar "$_Ink/list $_lnk $_Ink $_1nk $key"
    
    clear
    echo ""
    cd $HOME
    echo -e "        \033[1;33m • \033[1;32mINSTALLATION COMPLETED\033[1;33m • \033[0m"
    echo ""
    echo -e "\033[1;31m \033[1;33mMAIN COMMAND: \033[1;32mmenu\033[0m"
    echo -e "\033[1;33m MORE INFORMATION \033[1;31m(\033[1;36mTELEGRAM\033[1;31m): \033[1;37m@SSHPLUS\033[0m"
    
    # Start the menu after installation
    echo ""
    echo -e "\033[1;36mStarting menu system...\033[0m"
    sleep 2
    /bin/menu
    
elif [[ "$resposta" = '2' ]]; then
    # ARM architecture installation (similar structure but with ARM components)
    echo -e "\n\033[1;33mARM architecture installation would go here...\033[0m"
    sleep 2
    # Similar installation process for ARM
    create_menu_command
    echo -e "\n\033[1;32mInstallation completed! Use 'menu' command.\033[0m"
    sleep 2
    /bin/menu
else
    echo ""
    echo -e "\033[1;31mInvalid option!\033[0m"
    sleep 1
    exit
fi

rm $HOME/Plus && cat /dev/null >~/.bash_history && history -c
